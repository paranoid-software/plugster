export default class Plugster{constructor(t){this.name=this.constructor.name,console.log(this.name+" Controller Instantiated."),this._=t,this.childTemplates={},this.init(),Plugster.registry||(Plugster.registry={}),Plugster.registry[this.name.toLowerCase()]=this,Plugster.explicitSubscriptions||(Plugster.explicitSubscriptions={}),Plugster.htmlDeclaredSubscriptions||(Plugster.htmlDeclaredSubscriptions={})}toString(){return this.name}init(){let t=this;console.log(`Initializing ${t.name} Controller.`),t.bindOutlets((function(){console.log(t.name+" Controller Initialized"),t.afterInit()}))}afterInit(){throw new Error("You have to implement the Plugster afterInit method !!!")}bindOutlets(t){let e=this;console.log(`Binding Outlets for ${e.name} Controller.`);let i=[],s=`[data-controller-name=${e.name}]`;if(0===$(s).length)throw new Error(`There is no view with a ${e.name} controller !!!`);let r=$(s);$.map(e._,(function(t,s){let l=`[data-outlet-id='${s}']`;if(0===r.find(l).length)throw new Error(`Outlet ${s} does not exist, check both ${e.name} view and controller !!!`);let n=r.find(l);if(n.length>1){n=$.map(n,(function(t){return $(t).closest("[data-controller-name]").data("controller-name")===e.name?$(t):null}))[0]}if(n.data("child-templates")){n.buildListItem=function(t,i,r,l,n){this.items||(this.items={}),this.items[i]||(this.items[i]={}),this.append(e.childTemplates[`${s}_${t}`]);let o=e.compileChildTemplate(this.children().last(),l);return null===o?null:(o.root.attr("data-key",i),n&&o.root.click((function(){n(i,r)})),this.items[i].outlets=o,this.items[i].data=r,this.items[i].outlets)},n.count=function(){return Object.keys(this.items).length},n.getData=function(t){return this.items[t].data},n.getOutlets=function(t){return this.items[t].outlets},n.clear=function(){this.items=void 0,this.children().remove()};let t=n.data("child-templates");$.map(t,(function(t,r){let l=$.Deferred();i.push(l.promise()),e.loadChildTemplate(s,r,t,l)}))}e._[s]=n})),e._.root=r,Object.keys(r.data()).map((function(t){let i=t.replace(/[A-Z]/g,(t=>"-"+t.toLowerCase())).split("-");if(3!==i.length)return null;if("on"!==i[0])return null;let s=r.data(t);if(!e[s])throw new Error(`There is no method ${s} within the ${e.name} controller !!!`);let l=i[1],n=i[2];if(!Plugster.registry[l])throw new Error(`There is no ${l} controller !!!`);if(Object.getOwnPropertyNames(Object.getPrototypeOf(Plugster.registry[l])).map((t=>t.toLowerCase())).indexOf(n)<0)throw new Error(`There is no ${n} event in ${l} controller !!!`);Plugster.htmlDeclaredSubscriptions[`${l}_${n}_${e.name.toLowerCase()}`]={listener:e,methodName:s}})),console.log(`Outlets for ${e.name} Controller were binded successfuly !!!`),window.Promise.all(i).then((function(){t()}))}loadChildTemplate(t,e,i,s){let r=this;$.get({url:i,cache:!1},(function(l){r.childTemplates[`${t}_${e}`]=l,console.log(`Template ${i} loaded.`),s.resolve()}))}compileChildTemplate(t,e){if(!e||0===Object.keys(e).length)return null;let i={};return i.root=t,$.map(t.find("[data-child-outlet-id]"),(function(t){i[$(t).data("child-outlet-id")]=$(t)})),i}registerEventSignature(t,e,i){$(this).on(t,e,i)}dispatchEvent(t,e){this.broadcastExplicitSubscriptionsMessages(t,e),this.broadcastHtmlDeclaredSubscriptionsMessages(t,e),$(this).trigger(new $.Event(t,{args:e}))}broadcastExplicitSubscriptionsMessages(t,e){let i=this.name.toLowerCase(),s=`${this.name}_${t}`.toLowerCase();Plugster.explicitSubscriptions[i]?.onNewMessage(this.name,t,e),Plugster.explicitSubscriptions[s]?.onNewMessage(this.name,t,e)}broadcastHtmlDeclaredSubscriptionsMessages(t,e){let i=`${this.name}_${t}`.toLowerCase();Object.keys(Plugster.htmlDeclaredSubscriptions).map((function(t){if(t.startsWith(i)){let i=Plugster.htmlDeclaredSubscriptions[t];i.listener[i.methodName].call(i.listener,e)}}))}listenTo(t,e){e?Plugster.explicitSubscriptions[`${t.name}_${e.name}`.toLowerCase()]=this:Plugster.explicitSubscriptions[t.name.toLowerCase()]=this}}